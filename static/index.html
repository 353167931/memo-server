<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çµæ„Ÿå¤‡å¿˜å½•</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4A90D9">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, 'Microsoft YaHei', 'PingFang SC', sans-serif;
            background: #F5F6FA; max-width: 500px; margin: 0 auto;
            min-height: 100vh; -webkit-tap-highlight-color: transparent;
        }
        .header {
            background: linear-gradient(135deg, #4A90D9, #6BB5F5);
            color: white; padding: 16px 20px; font-size: 18px; font-weight: bold;
            position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 36px; height: 36px; border-radius: 18px; font-size: 18px; cursor: pointer; }
        .header-btn:active { background: rgba(255,255,255,0.35); }
        .auth-page { padding: 30px 24px; text-align: center; }
        .auth-icon { font-size: 56px; margin-bottom: 12px; }
        .auth-title { font-size: 22px; font-weight: bold; color: #333; margin-bottom: 6px; }
        .auth-hint { font-size: 13px; color: #999; margin-bottom: 24px; line-height: 1.6; }
        .auth-form { max-width: 340px; margin: 0 auto; text-align: left; }
        .auth-tabs { display: flex; margin-bottom: 20px; background: #F0F0F0; border-radius: 10px; padding: 3px; }
        .auth-tab { flex: 1; padding: 10px; text-align: center; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; color: #999; }
        .auth-tab.active { background: white; color: #4A90D9; }
        .form-group { margin-bottom: 14px; }
        .form-label { display: block; font-size: 13px; color: #666; margin-bottom: 5px; }
        .form-input { width: 100%; padding: 12px 14px; border: 1px solid #DDD; border-radius: 10px; font-size: 15px; outline: none; background: white; }
        .form-input:focus { border-color: #4A90D9; }
        textarea.form-input { resize: none; font-family: inherit; }
        .form-row { display: flex; gap: 8px; }
        .form-row > * { flex: 1; }
        .form-select { width: 100%; padding: 10px 12px; border: 1px solid #DDD; border-radius: 10px; font-size: 14px; background: white; outline: none; }
        .btn { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 15px; font-weight: bold; cursor: pointer; color: white; margin-bottom: 8px; }
        .btn:active { opacity: 0.8; }
        .btn:disabled { background: #CCC !important; }
        .btn-primary { background: linear-gradient(135deg, #4A90D9, #6BB5F5); }
        .btn-success { background: linear-gradient(135deg, #51CF66, #69DB7C); }
        .btn-outline { background: transparent; color: #FF6B6B; border: 1px solid #FF6B6B; }
        .msg { text-align: center; padding: 10px; border-radius: 8px; font-size: 13px; margin: 10px 0; }
        .msg-error { background: #FFF0F0; color: #FF6B6B; }
        .msg-success { background: #F0FFF4; color: #51CF66; }
        .tabs { display: flex; background: white; border-bottom: 1px solid #EEE; position: sticky; top: 56px; z-index: 90; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-size: 13px; color: #999; border-bottom: 2px solid transparent; }
        .tab.active { color: #4A90D9; border-bottom-color: #4A90D9; font-weight: bold; }
        .tab-content { padding: 12px 16px; padding-bottom: 40px; }
        .memo-item { background: white; border-radius: 12px; padding: 14px; margin-bottom: 8px; border: 1px solid #F0F0F0; display: flex; align-items: flex-start; gap: 10px; }
        .memo-item:active { transform: scale(0.99); }
        .memo-item.done { opacity: 0.5; }
        .memo-item.done .memo-text { text-decoration: line-through; }
        .memo-check { font-size: 22px; cursor: pointer; flex-shrink: 0; }
        .memo-body { flex: 1; min-width: 0; }
        .memo-text { font-size: 14px; color: #333; line-height: 1.5; word-break: break-all; }
        .memo-meta { font-size: 11px; color: #BBB; margin-top: 4px; display: flex; gap: 8px; flex-wrap: wrap; }
        .memo-tag { padding: 1px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .tag-å¾…åŠ { background: #E8F0FE; color: #4A90D9; }
        .tag-çµæ„Ÿ { background: #FFF8E1; color: #FFB020; }
        .tag-é‡è¦ { background: #FFE8E8; color: #FF4757; }
        .tag-ç”Ÿæ´» { background: #E8F8E8; color: #2ED573; }
        .memo-delete { font-size: 18px; cursor: pointer; color: #DDD; flex-shrink: 0; }
        .memo-delete:active { color: #FF6B6B; }
        .date-group { color: #4A90D9; font-size: 13px; font-weight: bold; padding: 14px 4px 6px; }
        .empty { text-align: center; color: #CCC; padding: 50px 20px; font-size: 15px; }
        .stats { font-size: 12px; color: #999; padding: 4px 0 8px; text-align: center; }
        .profile-card { background: white; border-radius: 16px; padding: 30px; margin: 16px 0; text-align: center; border: 1px solid #F0F0F0; }
        .hidden { display: none !important; }
        .toast { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 24px; border-radius: 20px; font-size: 13px; z-index: 999; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

<div class="toast" id="toast"></div>

<!-- ç™»å½•é¡µ -->
<div id="authPage">
    <div class="header">ğŸ“ çµæ„Ÿå¤‡å¿˜å½•</div>
    <div class="auth-page">
        <div class="auth-icon">ğŸ”</div>
        <div class="auth-title">æ¬¢è¿ä½¿ç”¨</div>
        <div class="auth-hint">é¦–æ¬¡ä½¿ç”¨è¯·ç‚¹å‡»ã€Œæ³¨å†Œã€åˆ›å»ºè´¦å·<br>å¤šè®¾å¤‡ä½¿ç”¨åŒä¸€è´¦å·ç™»å½•å³å¯åŒæ­¥æ•°æ®</div>
        <div class="auth-form">
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab(0)">ç™»å½•</div>
                <div class="auth-tab" onclick="switchAuthTab(1)">æ³¨å†Œ</div>
            </div>
            <div class="form-group">
                <label class="form-label">ğŸ‘¤ ç”¨æˆ·å</label>
                <input class="form-input" type="text" id="authUser" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            </div>
            <div class="form-group">
                <label class="form-label">ğŸ”‘ å¯†ç </label>
                <input class="form-input" type="password" id="authPass" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
            </div>
            <div id="regFields" class="hidden">
                <div class="form-group">
                    <label class="form-label">ğŸ”‘ ç¡®è®¤å¯†ç </label>
                    <input class="form-input" type="password" id="authPass2" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç ">
                </div>
            </div>
            <div id="loginBtns"><button class="btn btn-primary" onclick="doLogin()" id="btnLogin">ğŸ”‘ ç™»å½•</button></div>
            <div id="regBtns" class="hidden"><button class="btn btn-success" onclick="doRegister()" id="btnRegister">ğŸ“ æ³¨å†Œæ–°è´¦å·</button></div>
            <div id="authMsg"></div>
        </div>
    </div>
</div>

<!-- ä¸»é¡µ -->
<div id="mainPage" class="hidden">
    <div class="header">
        <span>ğŸ“ çµæ„Ÿå¤‡å¿˜å½•</span>
        <button class="header-btn" onclick="refreshData()">ğŸ”„</button>
    </div>
    <div class="tabs">
        <div class="tab active" onclick="switchTab(0)">ğŸ“ è®°å½•</div>
        <div class="tab" onclick="switchTab(1)">ğŸ“‹ å…¨éƒ¨</div>
        <div class="tab" onclick="switchTab(2)">ğŸ‘¤ æˆ‘çš„</div>
    </div>

    <div id="tab0" class="tab-content">
        <div class="form-group"><textarea class="form-input" id="memoContent" rows="3" placeholder="ğŸ’¡ è®°å½•ä½ çš„çµæ„Ÿæˆ–å¾…åŠäº‹é¡¹..."></textarea></div>
        <div class="form-row" style="margin-bottom:12px">
            <select class="form-select" id="memoTag"><option value="å¾…åŠ">ğŸ·ï¸ å¾…åŠ</option><option value="çµæ„Ÿ">ğŸ’¡ çµæ„Ÿ</option><option value="é‡è¦">â— é‡è¦</option><option value="ç”Ÿæ´»">ğŸŒ¿ ç”Ÿæ´»</option></select>
            <input class="form-input" type="date" id="memoDate">
        </div>
        <button class="btn btn-primary" onclick="addMemo()">âœ¨ ä¿å­˜</button>
        <div class="date-group" id="todayTitle"></div>
        <div id="todayList"></div>
    </div>

    <div id="tab1" class="tab-content hidden">
        <div class="form-group"><input class="form-input" type="text" id="searchBox" placeholder="ğŸ” æœç´¢..." oninput="debounceSearch()"></div>
        <div class="form-row" style="margin-bottom:12px">
            <select class="form-select" id="filterTag" onchange="loadAll()"><option value="">å…¨éƒ¨æ ‡ç­¾</option><option value="å¾…åŠ">å¾…åŠ</option><option value="çµæ„Ÿ">çµæ„Ÿ</option><option value="é‡è¦">é‡è¦</option><option value="ç”Ÿæ´»">ç”Ÿæ´»</option></select>
            <select class="form-select" id="filterStatus" onchange="loadAll()"><option value="">å…¨éƒ¨çŠ¶æ€</option><option value="undone">æœªå®Œæˆ</option><option value="done">å·²å®Œæˆ</option></select>
        </div>
        <div id="allStats" class="stats"></div>
        <div id="allList"></div>
    </div>

    <div id="tab2" class="tab-content hidden">
        <div class="profile-card">
            <div style="font-size:56px">ğŸ‘¤</div>
            <div style="font-size:18px;font-weight:bold;color:#333;margin:10px 0" id="profileName"></div>
            <div style="font-size:12px;color:#999;margin-bottom:20px">å¤šè®¾å¤‡ä½¿ç”¨åŒä¸€è´¦å·ç™»å½•å³å¯åŒæ­¥</div>
            <button class="btn btn-primary" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            <div id="syncStatus" class="hidden" style="margin-top:8px"></div>
            <button class="btn btn-outline" onclick="doLogout()" style="margin-top:20px">ğŸšª é€€å‡ºç™»å½•</button>
        </div>
    </div>
</div>

<script>
const API = window.location.origin + '/api';
let token = '';
let currentUser = null;
let searchTimer = null;

document.getElementById('memoDate').value = new Date().toISOString().split('T')[0];

try {
    const saved = localStorage.getItem('memo_auth');
    if (saved) { const a = JSON.parse(saved); token = a.token; currentUser = a; showMain(); }
} catch(e) {}

async function api(path, method, body) {
    const opts = { method: method || 'GET', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }};
    if (body) opts.body = JSON.stringify(body);
    const resp = await fetch(API + path, opts);
    const data = await resp.json();
    if (!resp.ok) {
        if (resp.status === 401) { doLogout(); alert('ç™»å½•å·²è¿‡æœŸ'); }
        throw new Error(data.error || 'è¯·æ±‚å¤±è´¥');
    }
    return data;
}

function showToast(t) { const e = document.getElementById('toast'); e.textContent = t; e.classList.add('show'); setTimeout(() => e.classList.remove('show'), 2000); }

function switchAuthTab(idx) {
    document.querySelectorAll('.auth-tab').forEach((t,i) => t.classList.toggle('active', i===idx));
    document.getElementById('loginBtns').classList.toggle('hidden', idx!==0);
    document.getElementById('regBtns').classList.toggle('hidden', idx!==1);
    document.getElementById('regFields').classList.toggle('hidden', idx!==1);
    document.getElementById('authMsg').className = ''; document.getElementById('authMsg').textContent = '';
}

function showAuthMsg(t, ok) { const e = document.getElementById('authMsg'); e.className = ok ? 'msg msg-success' : 'msg msg-error'; e.textContent = t; }

async function doRegister() {
    const u = document.getElementById('authUser').value.trim();
    const p = document.getElementById('authPass').value.trim();
    const p2 = document.getElementById('authPass2').value.trim();
    if (!u) { showAuthMsg('è¯·è¾“å…¥ç”¨æˆ·å'); return; }
    if (!p) { showAuthMsg('è¯·è¾“å…¥å¯†ç '); return; }
    if (p.length < 6) { showAuthMsg('å¯†ç è‡³å°‘6ä½'); return; }
    if (p !== p2) { showAuthMsg('ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´'); return; }
    const btn = document.getElementById('btnRegister'); btn.disabled = true; btn.textContent = 'â³ æ³¨å†Œä¸­...';
    try {
        const d = await api('/register', 'POST', {username: u, password: p});
        token = d.token; currentUser = d;
        localStorage.setItem('memo_auth', JSON.stringify(d));
        showAuthMsg('ğŸ‰ æ³¨å†ŒæˆåŠŸï¼', true); setTimeout(showMain, 500);
    } catch(e) { showAuthMsg(e.message); }
    finally { btn.disabled = false; btn.textContent = 'ğŸ“ æ³¨å†Œæ–°è´¦å·'; }
}

async function doLogin() {
    const u = document.getElementById('authUser').value.trim();
    const p = document.getElementById('authPass').value.trim();
    if (!u || !p) { showAuthMsg('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç '); return; }
    const btn = document.getElementById('btnLogin'); btn.disabled = true; btn.textContent = 'â³ ç™»å½•ä¸­...';
    try {
        const d = await api('/login', 'POST', {username: u, password: p});
        token = d.token; currentUser = d;
        localStorage.setItem('memo_auth', JSON.stringify(d));
        showAuthMsg('âœ… ç™»å½•æˆåŠŸï¼', true); setTimeout(showMain, 500);
    } catch(e) { showAuthMsg(e.message); }
    finally { btn.disabled = false; btn.textContent = 'ğŸ”‘ ç™»å½•'; }
}

function doLogout() { if (currentUser && !confirm('ç¡®å®šé€€å‡ºï¼Ÿ')) return; token = ''; currentUser = null; localStorage.removeItem('memo_auth');
    document.getElementById('authPage').classList.remove('hidden'); document.getElementById('mainPage').classList.add('hidden'); }

function showMain() { document.getElementById('authPage').classList.add('hidden'); document.getElementById('mainPage').classList.remove('hidden');
    document.getElementById('profileName').textContent = currentUser.username; loadToday(); }

function switchTab(idx) { document.querySelectorAll('.tab').forEach((t,i) => t.classList.toggle('active', i===idx));
    for(let i=0;i<3;i++) document.getElementById('tab'+i).classList.toggle('hidden', i!==idx);
    if(idx===0) loadToday(); if(idx===1) loadAll(); }

async function addMemo() { const c = document.getElementById('memoContent').value.trim(); if(!c) return;
    try { await api('/memos', 'POST', {content: c, tag: document.getElementById('memoTag').value, target_date: document.getElementById('memoDate').value});
        document.getElementById('memoContent').value = ''; showToast('âœ… å·²ä¿å­˜'); loadToday();
    } catch(e) { showToast('âŒ '+e.message); } }

async function toggleMemo(id) { try { await api('/memos/'+id+'/toggle', 'POST'); showToast('âœ…'); loadToday(); loadAll(); } catch(e) {} }

async function deleteMemo(id) { if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
    try { await api('/memos/'+id, 'DELETE'); showToast('ğŸ—‘ï¸ å·²åˆ é™¤'); loadToday(); loadAll(); } catch(e) {} }

async function loadToday() { const today = new Date().toISOString().split('T')[0];
    document.getElementById('todayTitle').textContent = 'ğŸ“‹ ä»Šæ—¥ ('+today+')';
    try { const d = await api('/memos?date='+today); render(d, 'todayList'); }
    catch(e) { document.getElementById('todayList').innerHTML = '<div class="empty">âš ï¸ '+e.message+'</div>'; } }

async function loadAll() { const kw = (document.getElementById('searchBox')?.value||'').trim();
    const tag = document.getElementById('filterTag')?.value||'';
    const st = document.getElementById('filterStatus')?.value||'';
    let url = '/memos?'; if(kw) url += 'keyword='+encodeURIComponent(kw)+'&'; if(tag) url += 'tag='+encodeURIComponent(tag)+'&'; if(st) url += 'status='+st+'&';
    try { const d = await api(url); const total=d.length, done=d.filter(m=>m.is_done).length;
        document.getElementById('allStats').textContent = 'ğŸ“Š å…±'+total+'æ¡ | âœ…å®Œæˆ'+done+' | â¬œæœªå®Œæˆ'+(total-done);
        render(d, 'allList', true);
    } catch(e) { document.getElementById('allList').innerHTML = '<div class="empty">âš ï¸</div>'; } }

function render(memos, id, showDate) { const el = document.getElementById(id);
    if(!memos?.length) { el.innerHTML = '<div class="empty">ğŸ“­ æš‚æ— å¤‡å¿˜å½•</div>'; return; }
    let html='', last='';
    memos.forEach(m => { if(showDate && m.target_date!==last) { last=m.target_date; html+='<div class="date-group">ğŸ“… '+last+'</div>'; }
        const tag=m.tag||'å¾…åŠ';
        html+='<div class="memo-item '+(m.is_done?'done':'')+'">'+
        '<span class="memo-check" onclick="toggleMemo('+m.id+')">'+(m.is_done?'âœ…':'â¬œ')+'</span>'+
        '<div class="memo-body"><div class="memo-text">'+esc(m.content)+'</div>'+
        '<div class="memo-meta"><span class="memo-tag tag-'+tag+'">'+tag+'</span>'+
        (!showDate&&m.target_date?'<span>ğŸ“… '+m.target_date+'</span>':'')+'</div></div>'+
        '<span class="memo-delete" onclick="deleteMemo('+m.id+')">ğŸ—‘ï¸</span></div>'; });
    el.innerHTML = html; }

function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }
function debounceSearch() { clearTimeout(searchTimer); searchTimer = setTimeout(loadAll, 300); }
function refreshData() { loadToday(); loadAll(); showToast('âœ… å·²åˆ·æ–°'); }
</script>
</body>
</html>